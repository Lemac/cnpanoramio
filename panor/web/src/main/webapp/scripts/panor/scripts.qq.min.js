"use strict";!function(a){"function"==typeof define&&define.amd?define([window,"jquery","cnmap"],a):a(window,jQuery)}(function(a){return a.cnmap.MapEventListener=function(b){this.opts=b||this.opts,this.addLocationHashListener=function(b,c){a.qq.maps.event.addListener(b,"idle",function(){var a=b.getCenter();c.apply(this,[a.lat,a.lng,b.getZoom()])})},this.addToolBar=function(){},this.setCenter=function(a,b,c){var d=new qq.maps.LatLng(b,c);a.setCenter(d)},this.setZoom=function(a,b){a.setZoom(Number(b))},this.setBounds=function(a,b,c){a.fitBounds(new qq.maps.LatLngBounds(new qq.maps.LatLng(b.lat,b.lng),new qq.maps.LatLng(c.lat,c.lng)))},this.clearMap=function(){},this.inMapView=function(a,b,c){c=c||this.opts.map;var d=new qq.maps.LatLng(a,b),e=c.getBounds();return e?e.contains(d):!1},this.addMarker=function(a,b,c){return new qq.maps.Marker({map:a,position:new qq.maps.LatLng(b,c)})},this.createDraggableMarker=function(a,b,c){return new qq.maps.Marker({draggable:!0,map:a,position:new qq.maps.LatLng(b,c)})},this.activeMarker=function(a){a&&(a.setZIndex(2),a.setIcon("images/marker.png"))},this.deactiveMarker=function(a){a&&(a.setZIndex(1),a.setIcon(""))},this.addMarkerActiveListener=function(b,c){function d(){c.apply(b,[])}a.qq.maps.event.addListener(b,"click",d),a.qq.maps.event.addListener(b,"dragend",d)},this.addDragendListener=function(b,c){a.qq.maps.event.addListener(b,"dragend",function(a){c.apply(b,[a.latLng.lat,a.latLng.lng])})},this.addMapClickListener=function(b,c){a.qq.maps.event.addListener(b,"click",function(a){var d=a.latLng;c.apply(b,[d.lat,d.lng])})},this.setPosition=function(a,b,c){var d=new qq.maps.LatLng(b,c);a.setPosition(d)},this.setMap=function(a,b){a.setMap(b)}},a.cnmap.MapEventListener.prototype=a.cnmap.IMapEventListener,a.cnmap.MapEventListener.factory=function(){return new a.cnmap.MapEventListener},a.cnmap.MapEventListener}),function(a){"function"==typeof define&&define.amd?define([window,"jquery","cnmap"],a):a(window,jQuery)}(function(a){return a.cnmap.MapService=function(a){var b={1:7,2:15,3:17,4:18,5:18,6:19};this.map=a||this.map;var c;this.init=function(){c=new qq.maps.Geocoder},this.getAddress=function(a,b,d){var e=new qq.maps.LatLng(a,b);c.setComplete(function(a){"GEO_INFO"==a.type&&d.apply(void 0,[a.detail.address])}),c.getAddress(e)},this.getAddrPois=function(a,b,d){var e=new qq.maps.LatLng(a,b);c.setComplete(function(a){if("GEO_INFO"==a.type){var b=a.detail,c={};angular.forEach(b.nearPois,function(a){c[a.address+" "+a.name]={poiweight:a.dist,location:a.latLng}}),d.apply(void 0,[c,b.address])}}),c.getAddress(e)},this.getLocation=function(a,b){c.setComplete(function(a){b.apply(void 0,[a])}),c.getLocation(a)},this.getLocPois=function(a,d){c.setComplete(function(a){var c=[];if("GEO_INFO"==a.type){var e=a.detail;c.push({address:e.address,location:e.location,similarity:e.similarity,zoom:b[e.gps_type]||3}),angular.forEach(e.similarResults,function(a){c.push({address:a.address,location:a.location,similarity:a.similarity,zoom:b[e.gps_type]||3})})}d.apply(void 0,[c])}),c.getLocation(a)}},a.cnmap.MapService.prototype=a.cnmap.IMapService,a.cnmap.MapService.factory=function(){return new a.cnmap.MapService},a.cnmap.MapService}),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(a&&(this.map=a),this.mapEventListener.setMap(this.marker,this.map),this.calcSpotTime(),c=[],this.travel){for(k=this.travel.spots,n=[],e=0,h=k.length;h>e;e++){for(d=k[e],l=d.photos,f=0,i=l.length;i>f;f++)b=l[f],this.createLabel(b);for(c=[],m=d.photos,g=0,j=m.length;j>g;g++)b=m[g],c.push(this.createPoint(b));n.push(new AMap.Polyline({map:this.map,path:c,strokeStyle:"dashed"}))}return n}},b.prototype.createPoint=function(a){return new AMap.LngLat(a.point.lng,a.point.lat)},b.prototype.createLabel=function(a){var b,c;return c=this,b=new AMap.Marker({map:this.map,position:new AMap.LngLat(a.point.lng,a.point.lat),offset:new AMap.Pixel(-15,-15),content:this.getLabelContent(a.oss_key)}),b.photoId=a.id,this.opts.clickable&&AMap.event.addListener(b,"click",function(){return jQuery(c).trigger("data_clicked",[this.photoId])}),b.photoId=a.id,b.setMap(this.map)},b.prototype.createSpot=function(a){var b,c,d,e,f,g;for(c=0,g=a.photos,e=0,f=g.length;f>e;e++)d=g[e],b=window.cnmap.GPS.distanceInMeter(a.center_lat,a.center_lng,d.point.lat,d.point.lng),b>c&&(c=b);return new AMap.Circle({map:this.map,center:new AMap.LngLat(a.center_lng,a.center_lat),radius:c,strokeStyle:"dashed",strokeColor:"#0066FF",strokeOpacity:.2,fillColor:"#0066FF",fillOpacity:.2})},b.prototype.createLine=function(a){var b,c,d;return c=function(){var c,e,f;for(f=[],b=c=0,e=a.length;e>c;b=++c)d=a[b],f.push(function(a){return new AMap.LngLat(a.center_lng,a.center_lat)}(d,b));return f}(),new AMap.Polyline({map:this.map,path:c,strokeStyle:"dashed"})},b.prototype.createMarker=function(){return new AMap.Marker({map:this.map,icon:"images/marker.png",animation:"AMAP_ANIMATION_BOUNCE"})},b}(window.cnmap.ITravelLayer),window.cnmap.TravelLayer=a}.call(this),function(a){"function"==typeof define&&define.amd?define([window,"jquery","Panoramio"],a):a(window,jQuery)}(function(a,b){return a.cnmap=a.cnmap||{},a.cnmap.PanoramioLayer=function(a){var c=new qq.maps.InfoWindow,d={},e=[];this.preZoom=0,this.preBounds=null,this.opts=b.extend({clickable:!0},a),this.opts.map&&this.setMap(this.opts.map),this.getMap=function(){return this.opts.map},this.setMap=function(a){function f(){var c=a.getBounds();if(c){var d=b(a.getContainer()),e={width:parseInt(d.width()),height:parseInt(d.height())};h.getBoundsThumbnails({ne:{lat:c.getNorthEast().lat,lng:c.getNorthEast().lng},sw:{lat:c.getSouthWest().lat,lng:c.getSouthWest().lng}},a.getZoom(),e,g)}}function g(f){var g=[],i={};for(var j in f)g.push(f[j].photo_id),i[f[j].photo_id]=f[j];cnmap.utils.compareArray(e,g,function(f,g,j){if(f){d[f]&&d[f].setVisible(!1);var k=e.indexOf(f);k>-1&&e.splice(k,1)}if(j)if(e.push(j),d[j])d[j].setVisible(!0),d[j].setMap(a);else{var l=new qq.maps.Label;l.photoId=j,l.setContent(h.getLabelContent(i[j].oss_key)),l.setMap(a),l.setPosition(new qq.maps.LatLng(i[j].lat,i[j].lng)),h.opts.clickable&&qq.maps.event.addListener(l,"click",function(){h.opts.suppressInfoWindows?(c.setOptions({content:h.getInfoWindowContent(i[this.photoId]),position:this.getPosition()}),c.open()):b(h).trigger("data_clicked",[this.photoId])}),d[j]=l}}),b(h).trigger("data_changed",[f])}if(a){this.opts.map=a,this.bindTo("zoom",a),this.bindTo("center",a),c.setMap(a);{qq.maps.event.addListener(a,"idle",f)}}else this.opts.map=void 0,this.clearVisible();var h=this},this.getLabelContent=function(a){return this.opts.phone?"<img src='"+this.staticCtx+"/"+a+"@!panor-lg' style='width: 34px; height: 34px;'>":"<img src='"+this.staticCtx+"/"+a+"@!panor-lg' style='width: 34px; height: 34px;'>"},this.getInfoWindowContent=function(a){var b,c=new Date(a.create_date);return b=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"<div class=\"panoramio-info-window\" style=\"'width': '200px','height': '200px','display': 'inline-block'\"><div class=\"header\">"+(a.address||"")+'</div><div class="body"><a href="'+this.ctx+"/photo/"+a.photo_id+'"><img src="'+this.ctx+"/api/rest/photo/"+a.photo_id+'/2"></a></div><div class="media"><a class="pull-left" href="'+this.ctx+"/user/"+a.user_id+'"><img class="media-object" src="'+this.ctx+"/api/rest/user/"+a.user_id+'/avatar" alt="'+a.username+'"></a><div class="media-body"><h4 class="media-heading">作者：<a href="'+this.ctx+"/user/"+a.user_id+'">'+a.username+"</a></h4>"+b+"</div></div></div>"},this.setOptions=function(a){this.opts=a},this.trigger=function(){qq.maps.event.trigger(this.opts.map,"idle")},this.center_changed=function(){}},a.cnmap.Panoramio.prototype=new qq.maps.MVCObject,a.cnmap.PanoramioLayer.prototype=new a.cnmap.Panoramio,a.cnmap.PanoramioLayer});