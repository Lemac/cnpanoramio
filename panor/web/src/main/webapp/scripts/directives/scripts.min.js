"use strict";angular.module("ponmApp.directives").filter("newlines",function(){return function(a){return a?a.split(/\n/g):""}}).filter("calculatetime",function(){return function(a){if(!a||!angular.isNumber(a))return"";var b=new Date(a),c=new Date,d=c-b,e=Math.round(d/864e5);if(1>e){var f=Math.round(d/36e5);if(1>f){var g=Math.round(d/6e4)+1;return g+"分钟前"}return f+"小时前"}return e>5?a:e+"天前"}}),angular.module("ponmApp.directives").directive("flexText",["$compile","$rootScope","$log",function(){function a(a,b){this.$textarea=a,this.options=b,this._init()}return a.prototype={_init:function(){var a=this;this.$textarea.wrap('<div class="flex-text-wrap" />').before("<pre><span /><br /></pre>"),a.options.hasUnderline&&this.$textarea.after('<div class="under-line"/>'),this.$span=this.$textarea.parent().find("span"),this.$underLine=this.$textarea.parent().find(".under-line"),this.$textarea.on("input propertychange keyup change",function(){a._mirror()}),this.$textarea.on("focus",function(){a.$underLine&&a.$underLine.addClass("active")}),this.$textarea.on("blur",function(){a.$underLine&&a.$underLine.removeClass("active")}),this._mirror()},_mirror:function(){this.$span.text(this.$textarea.val())}},{restrict:"A",link:function(b,c,d){var e=new a(c,{hasUnderline:!!d.hasUnderline});b.$watch(function(){return c.val()},function(){e._mirror()})}}}]),angular.module("ponmApp.directives").directive("ponmPhotoContainer",["$window","$parse","$animate","$log",function(a,b,c,d){var e=function(a,b){function e(){var d;m=new THREE.PerspectiveCamera(75,2,1,1100),m.target=new THREE.Vector3(0,0,0),n=new THREE.Scene;var e=new THREE.SphereGeometry(500,60,40);e.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));var k=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(b)});d=new THREE.Mesh(e,k),n.add(d),o=new THREE.WebGLRenderer,o.setSize(a.innerWidth(),a.innerHeight()),a.append(o.domElement),c.addClass(angular.element(o.domElement),"show"),o.domElement.addEventListener("mousedown",g,!1),o.domElement.addEventListener("mousemove",h,!1),o.domElement.addEventListener("mouseup",i,!1),o.domElement.addEventListener("mousewheel",j,!1),o.domElement.addEventListener("DOMMouseScroll",j,!1),o.domElement.addEventListener("click",function(a){a.preventDefault(),u=!u},!1),o.domElement.addEventListener("dragover",function(a){a.preventDefault(),a.dataTransfer.dropEffect="copy"},!1),o.domElement.addEventListener("dragenter",function(){document.body.style.opacity=.5},!1),o.domElement.addEventListener("dragleave",function(){document.body.style.opacity=1},!1),o.domElement.addEventListener("drop",function(a){a.preventDefault();var b=new FileReader;b.addEventListener("load",function(a){k.map.image.src=a.target.result,k.map.needsUpdate=!0},!1),b.readAsDataURL(a.dataTransfer.files[0]),document.body.style.opacity=1},!1),window.addEventListener("resize",f,!1)}function f(){m.updateProjectionMatrix(),o.setSize(a.innerWidth(),a.innerHeight())}function g(a){a.preventDefault(),t=!0,p=a.clientX,q=a.clientY,r=v,s=w}function h(a){t===!0&&(v=.1*(p-a.clientX)+r,w=.1*(a.clientY-q)+s)}function i(){t=!1}function j(a){a.preventDefault();var b=m.fov;a.wheelDeltaY?b-=.05*a.wheelDeltaY:a.wheelDelta?b-=.05*a.wheelDelta:a.detail&&(b+=1*a.detail),b>10&&150>b&&(m.fov=b),d.debug("camera.fov "+m.fov),m.updateProjectionMatrix()}function k(){requestAnimationFrame(k),l()}function l(){t===!1&&u&&(v+=.1),w=Math.max(-85,Math.min(85,w)),x=THREE.Math.degToRad(90-w),y=THREE.Math.degToRad(v),m.target.x=500*Math.sin(x)*Math.cos(y),m.target.y=500*Math.cos(x),m.target.z=500*Math.sin(x)*Math.sin(y),m.lookAt(m.target),o.render(n,m)}var m,n,o,p,q,r,s,t=!1,u=!0,v=0,w=0,x=0,y=0;return e(),k(),o.domElement};return{restrict:"EA",require:"",link:function(b,f,g){function h(a){if(m=f.find(".flat-image"),n=f.find(".p360-image"),m&&m.empty(),g.ponmPhotoSrcL2){var b=new Image;b.onload=function(){c.addClass(angular.element(this),"show")},b.src=g.ponmPhotoSrcL2,f.append(b)}if(g.ponmPhotoSrcL1){j=new Image,j.onload=function(){var a=angular.element(j);q||(k=a.outerWidth(),l=a.outerHeight(),q=l/k),i(),c.addClass(angular.element(this),"show"),b&&c.removeClass(angular.element(b),"show")},b&&(angular.element(j).css("position","absolute"),angular.element(j).css("top","0")),j.src=g.ponmPhotoSrcL1;var h=angular.element("<a href='#'></a>");h.on("click",function(a){a.preventDefault(),c.removeClass(m,"show"),c.addClass(o,"show"),c.addClass(n,"show"),n.find("canvas").length?c.addClass(n,"show"):e(n,g.ponmPhotoSrcL1,g.ponmPhotoWidth,g.ponmPhotoHeight)}),h.mouseenter(function(){h.find(".icon-p360").css("opacity",1)}),h.mouseout(function(){h.find(".icon-p360").css("opacity",.5)}),h.append("<div class='icon-p360'/>");var o=f.find(".flat-image-button");if(o.on("click",function(a){a.preventDefault(),d.debug("click on image360"),c.removeClass(n,"show"),c.removeClass(o,"show"),c.addClass(f.find(".flat-image"),"show")}),o.mouseenter(function(){o.find(".icon-pflat").css("opacity",1)}),o.mouseout(function(){o.find(".icon-pflat").css("opacity",.5)}),m||(m=angular.element("<div class='flat-image show'></div>")),m.append(j),a)m.append(h),f.append(m);else{f.append(m);var p=angular.element(m).panzoom({$zoomIn:f.parent().find(".zoom-in"),$zoomOut:f.parent().find(".zoom-out"),$zoomRange:f.parent().find(".zoom-range"),$reset:f.parent().find(".reset"),transition:!0});p.parent().on("mousewheel.focal",function(a){a.preventDefault();var b=a.delta||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0;p.panzoom("zoom",c,{increment:.1,animate:!0,focal:a})}),p.on("panzoomzoom",function(a,b,c){1>c?(p.panzoom("resetZoom"),p.panzoom("resetPan")):Math.abs(c-1)<.05&&(1!=c&&p.panzoom("resetZoom"),p.panzoom("resetPan"))})}}}function i(){if(o=f.innerWidth(),p=f.innerHeight(),p/o>q){var a=k>o?o:k;m.css("width",a),m.css("height",a*q)}else{var b=l>p?p:l;m.css("height",b),m.css("width",b/q)}}var j=null,k=1,l=1,m=null,n=null;f.addClass("ponm-photo-container"),f.css("width","100%"),f.css("height","100%"),f.css("background-color",g.ponmPhotoColor);var o=f.innerWidth(),p=f.innerHeight();b.$watch(function(){return g.ponmPhotoIs360},function(a){a&&"false"!=a?h(!0):h()}),angular.element(a).resize(function(){i()});var q=null}}}]),angular.module("ponmApp.directives").directive("photoFluidContainer",["$window","$parse","$animate","$log","$timeout",function(a,b,c,d,e){return{restrict:"A",link:function(b,c,f){function g(){var a=c.innerWidth()-10,b=c.find(k),e=[],f=0;angular.forEach(b,function(b){b=angular.element(b);var c=b.outerWidth(),d=b.outerHeight(),g=f+c*j/d;g>a?(h(e,a/f*j),e=[b],f=j*c/d):(e.push(b),f=g)}),e.length&&(d.debug("itemLineWidth: "+f),h(e,a/f*j))}function h(a,b){b>i&&(b=i),angular.forEach(a,function(a){var c=a.find("img");a.css("height",b+"px"),c.css("height",b-4+"px")})}var i=0,j=0;i=b.$eval(f.fluidLineMaxHeight)||200,j=b.$eval(f.fluidLineMinHeight)||100;var k=f.itemSelector||".fluid-brick";$(a).resize(function(){g()}),b.updateFluid=function(){if(d.debug("updateFluid"),a.imagesLoaded){var b=a.imagesLoaded&&a.imagesLoaded(c);b.on("always",function(){d.debug("imagesLoaded"),g()})}},e(function(){b.updateFluid()},1e3),b.$watch(f.photoFluidContainer,function(){e(function(){b.updateFluid()},1e3)})}}}]).directive("ponmPhoto",["$window","$parse","$animate","$log",function(a,b,c){return{restrict:"A",link:function(a,b){var d=b.find(".ponm-photo-footer");b.on("mouseenter",function(){c.addClass(d,"show")}),b.on("mouseleave",function(){c.removeClass(d,"show")})}}}]).directive("ponmHover",["$window","$parse","$animate","$log",function(){return{restrict:"A",link:function(a,b,c){var d=a.$eval(c.ponmHover);b.on("mouseenter",function(a){d.enter.apply(b,["enter",a])}),b.on("mouseleave",function(a){d.leave.apply(b,["leave",a])})}}}]),angular.module("ponmApp.directives").directive("repeatComplete",["$rootScope",function(a){function b(b,d){var e=++c;b.attr("repeat-complete-id",e),b.removeAttr("repeat-complete");var f=d.repeatComplete,g=b.parent(),h=g.scope()||a,i=h.$watch(function(){console.info("Digest running.");var a=g.children("*[ repeat-complete-id = '"+e+"' ]:last");if(a.length){var b=a.scope();b.$last&&(i(),b.$eval(f))}})}var c=0;return{compile:b,priority:1001,restrict:"A"}}]);