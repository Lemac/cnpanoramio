"use strict";angular.module("aTravelApp",["ponmApp","ponmApp.services","ponmApp.directives","ui.map"]).controller("ATravelCtrl",["$window","$scope","$log","$http","$location","TravelService",function(a,b,c,d,e,f){function g(a){f.getTravel({travelId:a},function(a){"OK"==a.status&&(b.travel=a.travel,angular.isArray(b.travel.spots)||(b.travel.spots=[]),b.travel.spot&&b.travel.spots.push(b.travel.spot),i.setTravel(b.travel),i.initMap())})}b.ctx=a.ctx,b.apirest=a.apirest;var h=a.cnmap.MapEventListener.factory(),i=new a.cnmap.TravelLayer({ctx:b.ctx,travel:b.travel});b.$watch(function(){return e.search()},function(a){a.id&&(b.travelId=a.id,g(a.id))}),b.$watch("myMap",function(a){i.setMap(a)}),b.$watchCollection("travel",function(a){c.debug(a)}),b.activePhoto=function(a){i.activePhoto(a)},b.activeSpot=function(a){i.activeSpot(a)},b.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0},b.$watch("myMap",function(){var a=b.myMap;h.addToolBar(a)}),b.scrollCallback=function(){c.debug("scrollCallback")}}]),angular.module("ponmApp.controllers").controller("ChLocModalCtrl",["$window","$scope","$log","$modalInstance","files","GPSConvertService",function(a,b,c,d,e){function f(a,c,d){if(a.mapVendor=a.mapVendor||{},c&&d)a.mapVendor.lat=c,a.mapVendor.lng=d;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=i.createDraggableMarker(b.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,i.setMap(a.mapVendor.marker,b.map),i.addMarkerActiveListener(a.mapVendor.marker,function(){b.activePhoto(this.photo_file)}),i.addDragendListener(a.mapVendor.marker,function(a,c){b.setPlace(this.photo_file,a,c)})}function g(a){i.addMapClickListener(a,function(a,c){h(b.file,a,c),b.setPlace(b.file,a,c)})}function h(a,c,d){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(i.setPosition(a.mapVendor.marker,c,d),i.setMap(a.mapVendor.marker,b.map)):(f(a,c,d),i.activeMarker(a.mapVendor.marker))}var i=a.cnmap.MapEventListener.factory(),j=a.cnmap.MapService.factory();b.mapEventListener=i,b.mapService=j,angular.forEach(e,function(a){if(a.active=!1,delete a.mapVendor,!a.modal&&a.preview){var b=cnmap.cloneCanvas(a.preview);a.modal={preview:b}}a.mapVendor=a.mapVendor||{},a.mapVendor.is360=a.is360}),angular.forEach(e,function(a){!a.loc_preview&&loadImage&&loadImage(a,function(b){a.loc_preview=a.loc_preview||{},jQuery(b).removeAttr("width").removeAttr("height"),a.loc_preview.preview=b},{maxWidth:600,maxHeight:300,minWidth:100,minHeight:50,canvas:!1})}),b.files=e,b.file=b.files[0],b.ok=function(){var a=[];angular.forEach(e,function(b){b.mapVendor&&(b.address=b.mapVendor.address,b.is360=b.mapVendor.is360,b.lat=b.mapVendor.lat,b.lng=b.mapVendor.lng,b.latPritty=b.mapVendor.latPritty,b.lngPritty=b.mapVendor.lngPritty,b.vendor="gaode",a.push(b))}),d.close(a)},b.cancel=function(){d.dismiss("cancel")},b.$watch("$$childTail",function(){b.$$childTail&&b.$$childTail.$watch("myMap",function(){b.$$childTail.myMap&&(b.map=b.$$childTail.myMap,angular.forEach(e,function(a){f(a)}),j.init(b.map),g(b.map),b.activePhoto(b.file))})}),b.addOrUpdateMarker=h,b.setPlace=function(a,c,d,e){b.file.mapVendor=b.file.mapVendor||{},b.file.mapVendor.lat=c,b.file.mapVendor.lng=d,b.file.mapVendor.latPritty=cnmap.GPS.convert(c),b.file.mapVendor.lngPritty=cnmap.GPS.convert(d),e?b.file.mapVendor.address=e:j.getAddress(c,d,function(a){b.$apply(function(){b.file.mapVendor.address=a})})},b.clearPlace=function(){},b.activePhoto=function(a){b.file.active=!1,b.file.mapVendor&&i.deactiveMarker(b.file.mapVendor.marker),b.file=a,b.file.active=!0,b.file.mapVendor&&(b.file.mapVendor.lat?(i.activeMarker(b.file.mapVendor.marker),i.inMapView(b.file.mapVendor.lat,b.file.mapVendor.lng,b.map)||i.setCenter(b.map,b.file.mapVendor.lat,b.file.mapVendor.lng),b.setPlace(b.file,b.file.mapVendor.lat,b.file.mapVendor.lng)):b.clearPlace())},b.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http",function(a,b){a.selected=void 0,a.states=[],a.getLocation=function(a){return b.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},a.goLocation=function(b){var c=b.geometry;c&&(a.mapEventListener.setCenter(a.map,c.location.lat,c.location.lng),a.addOrUpdateMarker(a.file,c.location.lat,c.location.lng),a.setPlace(a.file,c.location.lat,c.location.lng,b.formatted_address),a.mapEventListener.setBounds(a.map,c.viewport.southwest,c.viewport.northeast))}}]),angular.module("ponmApp.controllers").controller("ChUserAvatarCtrl",["$window","$scope","$log","$sce","$http","$modalInstance",function(a,b,c,d,e,f){var g=a.apirest+"/user/avatar";b.cancel=function(){f.dismiss(b.avatar)};var h=a.URL&&a.URL.createObjectURL.bind(a.URL)||a.webkitURL&&a.webkitURL.createObjectURL.bind(a.webkitURL)||a.createObjectURL;b.fileUpload=function(){if(b.closeAlert(0),b.$$childTail.$$childTail.previewUrl){var a=Math.random().toString().substr(2),c="";c+="--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="avatar.png"\r\nContent-type: application/octet-stream\r\n\r\n'+b.$$childTail.$$childTail.previewUrl+"\r\n",c+="--"+a+"--\r\n",e({method:"POST",url:g,data:c,headers:{"Content-Type":"multipart/form-data; charset=utf-8; boundary="+a}}).success(function(a){"OK"==a.status?(b.avatar=a.open_info.avatar,b.addAlert({type:"success",msg:"上传成功!"})):b.addAlert({type:"danger",msg:"上传失败!"})})}},b.onFileSelect=function(a){b.closeAlert(0);var c=d.trustAsResourceUrl(h(a[0]));b.imageUrl=c},b.addAlert=function(a){b.alerts=[],b.alerts.push(a)},b.closeAlert=function(a){b.alerts&&b.alerts.splice(a,1)}}]).directive("imgCropped",function(){return{restrict:"E",replace:!0,scope:{src:"@",bind:"=previewUrl"},link:function(a,b){function c(b){var c=d[0],f=c.width,g=c.height,h=$(c).width(),i=$(c).height(),j=b.x*f/h,k=b.y*g/i,l=b.w*f/h,m=b.h*g/i,n=document.createElement("canvas");n.width=100,n.height=100;var o=n.getContext("2d");o.drawImage(c,j,k,l,m,0,0,100,100),a.$apply(function(){a.previewUrl=n.toDataURL("image/png"),e.attr("src",a.previewUrl)})}var d,e,f=800,g=420,h=function(){d&&(d.next().remove(),d.remove(),d=void 0),e&&(e.next().remove(),e.remove(),e=void 0)};a.$watch("src",function(a){h(),a&&(b.after("<img />"),d=b.next(),d.attr("src",a),$(d).Jcrop({trackDocument:!0,bgFade:!0,boxWidth:f,boxHeight:g,minSize:[16,16],onSelect:c,aspectRatio:1}),d.after("<img />"),e=d.next())}),a.$on("$destroy",h)}}}).directive("ngFileSelect",["$parse","$timeout",function(a,b){return function(c,d,e){var f=a(e.ngFileSelect);d.bind("change",function(a){var d,e,g=[];if(d=a.target.files,null!=d)for(e=0;e<d.length;e++)g.push(d.item(e));b(function(){f(c,{$files:g,$event:a})})}),d.bind("click",function(){this.value=null})}}]),angular.module("exploreWorldApp",["ponmApp","ponmApp.services","ui.map"]).controller("ExploreWorldCtrl",["$window","$location","$scope","UserService",function(a,b,c,d){function e(){c.photoEnd=c.slice+g<=c.allPhotos.length?!1:!0,c.photoStart=c.slice>=g?!1:!0}function f(a){i.addLocationHashListener(a,function(a,c,d){if(!k){var e=jQuery.deparam(b.hash());a&&c&&(j.lat=a,j.lng=c,j.zoom=d,(j.lat!=e.lat||j.lng!=e.lng||j.zoom!=e.zoom||j.latest!=e.latest||j.userid!=e.userid||j.favorite!=e.favorite)&&(this.setState&&clearTimeout(this.setState),k=!0,b.hash(jQuery.param(j)),this.setState=setTimeout(function(){k=!1},500)))}}),c.$watch(function(){return b.hash()},function(b){if(!k){var d=jQuery.deparam(b);if(d.lat&&d.lng&&(j.lat!=d.lat||j.lng!=d.lng||j.zoom!=d.zoom)&&(this.setState&&clearTimeout(this.setState),k=!0,i.setCenter(a,d.lat,d.lng),d.zoom&&i.setZoom(a,d.zoom),this.setState=setTimeout(function(){k=!1},500),d.bounds)){var e=d.bounds.split(",");(e.lenght=4)&&i.setBounds(a,{lat:e[0],lng:e[1]},{lat:e[2],lng:e[3]})}angular.copy(d,j),d.latest?c.setPanormaioType("latest"):d.userid&&(d.favorite?c.setPanormaioType("favorite",d.userid):c.setPanormaioType("user",d.userid))}})}c.ctx=a.ctx,c.apirest=a.apirest,c.login=a.login,c.userId=a.userId,c.user={},c.login&&c.userId&&(c.user={id:c.userId,name:"您"}),c.tabs={map:!0},c.photos=[],c.allPhotos=[],c.slice=0,c.photoStart=!0,c.photoEnd=!0,c.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0};var g=20;"qq"==a.mapVendor&&(a.mapVendor="gaode");var h=new cnmap.PanoramioLayer({suppressInfoWindows:!0,mapVendor:a.mapVendor||"gaode"});h.initEnv(a.ctx),$(h).bind("data_changed",function(a,b){c.$apply(function(){var a=jQuery("div#thumbinnerarea"),d=a.innerWidth(),e=a.innerHeight(),f=Math.floor((d-40)/116);g=f*Math.floor((e-50)/116),c.updatePhoto(b)})}),c.setPanormaioType=function(a,b){switch(c.tabs={},c.tabs[a]=!0,b&&(c.user.id=b,c.login&&b==c.userId?c.user.name="您":d.getOpenInfo({userId:b},function(a){"OK"==a.status&&(c.user.name=a.open_info&&a.open_info.name)})),h.setFavorite(!1),h.setUserId(""),h.setLatest(!1),delete j.userid,delete j.latest,delete j.favorite,a){case"user":h.setFavorite(!1),h.setUserId(c.user.id),j.userid=c.user.id;break;case"map":h.setUserId(void 0);break;case"latest":h.setLatest(!0),j.latest=!0;break;case"favorite":h.setFavorite(!0),j.favorite=!0,h.setUserId(c.user.id),j.userid=c.user.id}h.trigger("changed")},c.updatePhoto=function(a){c.allPhotos=a,c.photos=a.slice(0,g),c.slice=0,e()},c.nextPhoto=function(){c.slice<=c.allPhotos.length&&(c.slice=c.slice+g,c.photos=c.allPhotos.slice(c.slice,c.slice+g),e())},c.prePhoto=function(){c.slice>=g&&(c.slice=c.slice-g,c.photos=c.allPhotos.slice(c.slice,c.slice+g),e())};var i=a.cnmap.MapEventListener.factory();c.$watch("myMap",function(){if(!c.map){c.map=c.myMap;var a=c.myMap;h.setMap(a),f(a),i.addToolBar(a)}});var j={},k=!1}]),angular.module("map.AMap",["ngRoute","ngResource","ui.bootstrap"]).controller("TypeaheadCtrl",["$scope","$log","$http",function(a,b,c){a.getLocation=function(a){return c.get("http://restapi.amap.com/v3/geocode/geo",{params:{key:"53f7e239ddb8ea62ba552742a233ed1f",address:a}}).then(function(a){var c=[];return angular.forEach(a.data.geocodes,function(a){b.debug(a),c.push(a)}),c})},a.update=function(a){var c=a.location;c&&(c=c.split(","),b.debug(c))}}]),angular.module("indexApp",["ponmApp","ui.map"]).controller("IndexCtrl",["$window","$scope",function(a,b){function c(a){$(".front-photo_sizer img").attr("src",ctx+"/api/rest/photo/"+a.id+"/1"),$(".front-photo_sizer a").attr("href",ctx+"/photo/"+a.id),d.setCenter(b.map,a.lat,a.lng),a.mark||(a.mark=!0,d.createDraggableMarker(b.map,a.lat,a.lng)),$("div.imgLiquidFill").imgLiquid({fill:!0}),e.length>1&&setTimeout(function(){c(e[f]),f=(f+1)%e.length},4e3)}var d=a.cnmap.MapEventListener.factory();b.mapOptions={resizeEnable:!0,panControl:!1,zoomControl:!1,uiMapCache:!1},$("div.imgLiquidFill").imgLiquid({fill:!0});var e,f,g=new $.RestClient(window.ctx+"/api/rest/");g.add("index"),g.index.read("photo").done(function(a){e=a,f=0,e.length&&(c(e[f]),f=(f+1)%e.length)})}]),angular.module("mapPhotoApp",["ponmApp","ui.bootstrap","ui.map"]).controller("MapPhotoCtrl",["$window","$location","$log","$scope","PhotoService",function(a,b,c,d,e){function f(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&j.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},e.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.file.is360=a.prop.is360)}),e.getGPSInfo({photoId:d.photoId},function(a){"OK"==a.status&&(i(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng),j.setCenter(d.map,a.gps[0].gps.lat,a.gps[0].gps.lng),d.setPlace(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng,a.gps[0].gps.address))})}function g(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=j.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,j.setMap(a.mapVendor.marker,d.map),j.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function h(a){j.addMapClickListener(a,function(a,b){i(d.file,a,b),d.setPlace(d.file,a,b)})}function i(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(j.setPosition(a.mapVendor.marker,b,c),j.setMap(a.mapVendor.marker,d.map)):(g(a,b,c),j.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.apirest=a.apirest;var j=a.cnmap.MapEventListener.factory(),k=a.cnmap.MapService.factory();d.mapEventListener=j,d.mapService=k,d.$watch(function(){return b.hash()},function(a){var b=jQuery.deparam(a);b&&b.id&&(d.photoId=b.id,f(d.photoId))}),d.ok=function(){e.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(c.debug("properties update successful"),d.addAlert({type:"success",msg:"保存成功!"})):d.addAlert({type:"danger",msg:"保存失败 "+a.status})})},d.cancel=function(){a.history.back()},d.$watch("myMap",function(a){d.map=a,k.init(a),h(d.map),f()}),d.addOrUpdateMarker=i,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e?d.file.mapVendor.address=e:k.getAddress(b,c,function(a){d.$apply(function(){d.file.mapVendor.address=a})})},d.clearPlace=function(){},d.addAlert=function(a){d.alerts=[],d.alerts.push(a)},d.closeAlert=function(a){d.alerts&&d.alerts.splice(a,1)},d.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http",function(a,b){a.selected=void 0,a.states=[],a.getLocation=function(a){return b.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},a.goLocation=function(b){var c=b.geometry;c&&(a.mapEventListener.setCenter(a.map,c.location.lat,c.location.lng),a.addOrUpdateMarker(a.file,c.location.lat,c.location.lng),a.setPlace(a.file,c.location.lat,c.location.lng,b.formatted_address),a.mapEventListener.setBounds(a.map,c.viewport.southwest,c.viewport.northeast))}}]),angular.module("ponm.Navbar",["ngResource","ui.bootstrap"]).controller("SearchLocCtrl",["$window","$scope","$log","$http",function(a,b,c,d){b.ctx=a.ctx,b.getLocation=function(a){return d.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},b.update=function(c){var d=c.geometry;d&&(a.location=b.ctx+"/map##lat="+d.location.lat+"&lng="+d.location.lng+"&bounds="+d.bounds.southwest.lat+","+d.bounds.southwest.lng+","+d.bounds.northeast.lat+","+d.bounds.northeast.lng)}}]),angular.module("photoApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui.map","ponmApp","ponmApp.services","ponmApp.directives"]).controller("PhotoCtrl",["$window","$location","$log","$rootScope","$scope","$cookieStore","$cookies","PhotoService","CommentService","UserService","UserPhoto",function(a,b,c,d,e,f,g,h,i,j,k){function l(){h.getComments({photoId:e.photoId,pageSize:e.comment.pageSize,pageNo:e.comment.currentPage},function(a){"OK"==a.status&&(e.comments=a.comments)},function(){})}e.ctx=a.ctx,e.apirest=a.apirest;var m=a.cnmap.MapEventListener.factory(),n=b.absUrl(),o=n.match(/\/photo\/[0-9]+/g);e.photoId=o?o[0].match(/[0-9]+/g)[0]:8,e.photo={},e.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},e.comments=[],e.$watch("comment.currentPage",function(){l()}),e.user={},e.user.userId=a.userId,e.user.username=g.username,e.user.login=a.login,e.photo={},h.getPhoto({photoId:e.photoId},function(a){c.debug(a),"OK"==a.status&&(e.photo=a.prop,e.comment.totalItems=a.prop.comment_count,e.comment.numPages=Math.ceil(e.comment.totalItems/e.comment.pageSize),e.photo.save=function(){e.editable="",h.updateProperties({photoId:e.photoId},{title:e.photo.title,description:e.photo.description},function(){})},j.getOpenInfo({userId:e.photo.user_id},function(a){"OK"==a.status&&(e.userOpenInfo=a.open_info)}),k.get({userId:e.photo.user_id,pageSize:e.photoId},function(a){"OK"==a.status&&(e.user_photos=a.photos.slice(0,6))}))}),h.getGPSInfo({photoId:e.photoId,vendor:"gaode"},function(a){"OK"==a.status&&a.gps.length&&(e.gpsInfo=a.gps[0],c.debug(e.gpsInfo),e.gpsInfo.lat=cnmap.GPS.convert(e.gpsInfo.gps.lat),e.gpsInfo.lng=cnmap.GPS.convert(e.gpsInfo.gps.lng),m.setCenter(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng),m.addMarker(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng))}),h.getCameraInfo({photoId:e.photoId},function(a){"OK"==a.status&&(e.cameraInfo=a.camera_info),c.debug(e.cameraInfo)}),l(),e.user.login&&e.user.userId&&j.getOpenInfo({userId:e.user.userId},function(a){"OK"==a.status&&(e.user.open_info=a.open_info)}),e.setEditable=function(a){"true"==e.user.login&&e.userOpenInfo.name==e.user.username&&(e.editable=a)},e.deletePhoto=function(){a.alert("您确定要删除这张照片？")},e.createComment=function(a){a&&i.save({photoId:e.photoId,content:a},function(a){"OK"==a.status&&(e.comment.content="",e.comment.count=e.comment.count+1,e.comments.splice(0,0,a.comment))})},e.favorite=function(){e.user.login&&(e.photo.favorite?h.removeFavorite({photoId:e.photoId},function(a){"OK"==a.status&&(e.photo.favorite=!1)}):h.favorite({photoId:e.photoId},{},function(a){"OK"==a.status&&(e.photo.favorite=!0)}))},e.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,panControl:!1,level:13,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx),$(p).bind("data_changed",function(a,b){e.$apply(function(){e.update_nearby_photos(b)})}),e.$watch("minimap1",function(){if(!e.map){e.map=e.minimap1;var a=e.minimap1;p.setMap(a)}}),e.update_nearby_photos=function(a){e.nearby_photos=a&&a.slice(0,5)}}]),angular.module("ponmApp.controllers").controller("PhotoModalCtrl",["$window","$scope","$log","$modalInstance","photoId","PhotoService","CommentService","UserService",function(a,b,c,d,e,f,g,h){function i(){f.getComments({photoId:e,pageSize:b.comment.pageSize,pageNo:b.comment.currentPage},function(a){"OK"==a.status&&(b.comments=a.comments)},function(){})}b.ctx=a.ctx,b.apirest=a.apirest,b.photoId=e,c.debug(e),b.photoDetailCollapsed=!0,b.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},b.comments=[{userId:2,username:"user",content:"asdfqaef",createTime:1401901233320},{userId:2,username:"user",content:"aidufhqwiejfaosidjfow",createTime:1401921233320},{userId:2,username:"user",content:"asdfqaef",createTime:1401901233320},{userId:2,username:"user",content:"aidufhqwiejfaosidjfow",createTime:1401921233320}],b.detail={},f.getPhoto({photoId:b.photoId},function(a){c.debug(a),"OK"==a.status&&(b.photo=a.prop,b.comment.totalItems=a.prop.comment_count,b.comment.numPages=Math.ceil(b.comment.totalItems/b.comment.pageSize),b.photo.save=function(){b.editable="",f.updateProperties({photoId:b.photoId},{title:b.photo.title,description:b.photo.description},function(){})},h.getOpenInfo({userId:b.photo.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}))}),i(),f.getCameraInfo({photoId:e},function(a){"OK"==a.status&&(b.cameraInfo=a.camera_info),c.debug(b.cameraInfo)}),b.createComment=function(){var a=b.comment.content;a&&g.save({photoId:b.photoId,content:a},function(a){"OK"==a.status&&(b.comment.content="",b.comment.count=b.comment.count+1,b.comments.splice(0,0,a.comment))})},b.cancel=function(){d.dismiss("cancel")}}]),angular.module("userPageApp",["ui.bootstrap","ui.map","ponmApp","ponmApp.services","ponmApp.directives","ponmApp.controllers","xeditable"]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("UserCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal",function(a,b,c,d,e,f,g){function h(a){a?e.getByTag({userId:d.userId,tag:a,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)}):e.get({userId:d.userId,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)})}function i(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info)})}function j(a){e.get({userId:d.userId,pageSize:a},function(a){if("OK"==a.status){var b=a.photo_info.photo_num;d.photo.totalItems=a.photo_info.photo_count,d.photo.currentPage=Math.ceil(b/d.photo.pageSize),d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h()}})}function k(a){e.getByTag({userId:d.userId,tag:a},function(b){"OK"==b.status&&(d.photo.totalItems=b.photo_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h(a))})}function l(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.photo.totalItems=a.open_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h())})}d.ctx=a.ctx,d.apirest=a.apirest;var m=b.absUrl(),n=m.match(/\/user\/[0-9]+/g);d.userId=n?n[0].match(/[0-9]+/g)[0]:3,d.photo={pageSize:40,totalItems:0,numPages:0,currentPage:1,maxSize:10},d.photos=[],d.tag="",d.$watch("photo.currentPage",function(){h(d.tag)});var o=b.search();o&&(o.with_photo_id?(j(o.with_photo_id),i()):o.tag?(d.tag=o.tag,k(o.tag),i()):l()),d.$watch(function(){return b.search()},function(a){a&&(a.with_photo_id?j(a.with_photo_id):a.tag?(d.tag=a.tag,k(a.tag)):l())}),d.$watch("photos",function(){angular.forEach(d.photos,function(a){a.backgroundColor="grey"})}),d.activePhoto=function(a){var b=g.open({templateUrl:"../views/photo.html",controller:"PhotoModalCtrl",resolve:{photoId:function(){return a.id}}});b.result.then(function(a){d.selected=a},function(){})},d.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,level:3,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx),p.setUserId(d.userId),d.$watch("minimap",function(){if(!d.map){d.map=d.minimap;var a=d.minimap;p.setMap(a)}})}]),angular.module("userSettingsApp",["ngResource","ui.bootstrap","ponmApp"]).controller("UserSettingsCtrl",["$window","$log","$location","$rootScope","$scope","$modal","UserPhoto","UserService",function(a,b,c,d,e,f,g,h){function i(){h.getSettings({userId:e.userId},function(a){"OK"==a.status&&(e.settings=a.settings)})}e.ctx=a.ctx,e.apirest=a.apirest,e.avatar=e.userId=a.userId,e.changeAvatar=function(){e.avatar=1;var a=f.open({templateUrl:"views/changeUserAvatar.html",controller:"ChUserAvatarCtrl",resolve:{}});a.result.then(function(){e.avatar=e.userId},function(){e.avatar=e.userId,b.info("Modal dismissed at: "+new Date)})},i(),e.submit=function(){h.updateSettings({userId:e.userId},e.settings,function(a){e.addAlert("OK"==a.status?{type:"success",msg:"保存成功!"}:{type:"danger",msg:"保存失败!"})},function(){e.addAlert({type:"danger",msg:"保存失败!"})})},e.addAlert=function(a){e.alerts=[],e.alerts.push(a)},e.closeAlert=function(a){e.alerts&&e.alerts.splice(a,1)}}]),function(){angular.module("fileuploadApp",["ngResource","ui.bootstrap","blueimp.fileupload","ui.map","ponmApp"]).config(["$httpProvider","fileUploadProvider","$logProvider",function(a,b){delete a.defaults.headers.common["X-Requested-With"],b.defaults.redirect=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s"),angular.extend(b.defaults,{autoUpload:!0,maxFileSize:5e6})}]).controller("DemoFileUploadController",["$scope","$http","fileUpload","$modal","$log","PhotoService","$window","GPSConvertService","LoginUserService","UserService","TravelService",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){a.photoId=b.id,a.is360=b.is360,b.point&&(a.lat=b.point.lat,a.lng=b.point.lng,a.vendor=b.vendor,a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng))}function m(){if(a.travel){var b=[];angular.forEach(a.queue,function(a){a.photoId&&b.push(a.photoId)}),b.length&&k.create({travelId:a.travel.id},jQuery.param({photos:b.join(",")}),function(a){"OK"==a.status})}}a.apirest=g.apirest,a.ctx=g.ctx,a.userId=g.userId,a.options={formData:function(){var a=this.files[0].lat||0,b=this.files[0].lng||0,c=this.files[0].address||"",d=this.files[0].vendor||"gps";return[{name:"lat",value:a},{name:"lng",value:b},{name:"address",value:c},{name:"vendor",value:d}]},done:function(a,b){if("OK"==b.result.status){var c=b.result.prop;b.files[0].$submit=!1,b.files[0].$cancel=!1,b.files[0].$endestroy=!0,l(b.files[0],c),b.files[0].saveProperties(),b.files[0].saveTags(),m()}else"NO_AUTHORIZE"==b.result.status?(b.files[0].error="请重新登录",b.files[0].$endestroy=!1):(b.files[0].error=b.result.info,b.files[0].$endestroy=!1)},fail:function(a,b){b.result?("NO_AUTHORIZE"==b.result.status&&(b.files[0].error="请重新登录"),b.files[0].$cancel=function(){b.files[0].$destroy()}):c.defaults.fail(a,b)}},a.changeLocation=function(a){var b=d.open({templateUrl:"views/changeLocationModal.html",controller:"ChLocModalCtrl",resolve:{files:function(){return a}}});b.result.then(function(a){angular.forEach(a,function(a){a.saveProperties()})},function(){e.info("Modal dismissed at: "+new Date)})},a.loadTravelData=function(a){var b=j.getTravels({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.travels])});e.debug(b)},a.newTravelData=function(a,b){return e.debug("new data: "+a),k.create({},jQuery.param({travel:a}),function(a){"OK"==a.status&&b&&b.apply(void 0,[a.travels])}),!1},a.loadTagData=function(a){return e.debug("load tags data"),j.getTags({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.tags])}),!0},a.newTagData=function(a,b){return e.debug("new data: "+a),j.createTag({userId:i.getUserId(),value:a},function(a){"OK"==a.status&&b&&b.apply(void 0,[a.open_info.tags])}),!1},a.$watch("travel",function(){m()}),a.$watch("tags",function(){angular.forEach(a.queue,function(a){a.photoId&&a.saveTags()})})}]).controller("FileDestroyController",["$scope","$http","PhotoService",function(a,b,c){var d,e=a.file;e.$state=function(){return d},e.$destroy=function(){e.photoId&&(d="pending",c.delete({photoId:e.photoId},function(a){d=a?"resolved":"rejected"})),a.clear(e)},e.$cancel||e._index||(e.$cancel=function(){a.clear(e)})}]).controller("TitleEditorCtrl",["$scope","$http","PhotoService","$log",function(a,b,c,d){var e=a.file;e.saveProperties=function(){if(this.photoId){var a=this;c.updateProperties({photoId:a.photoId},{title:a.title,description:a.description,point:{lat:a.lat,lng:a.lng,address:a.address},vendor:a.vendor,file_size:a.size,is360:a.is360},function(a){a&&d.debug("properties update successful")})}},e.saveTags=function(){var b=this;if(b.photoId&&b.tags){var e=[];e=e.concat(b.tags||[]).concat(a.tags||[]),e.length&&c.tag({photoId:b.photoId},e,function(a){a&&d.debug("tags update successful")})}},a.$watch("title",function(){a.file.title=a.title,e.saveProperties()}),a.$watch("description",function(){a.file.description=a.description,e.saveProperties()}),a.$watch("file.tags",function(){e.saveTags()})}])}();