"use strict";angular.module("ponmApp.directives").filter("newlines",function(){return function(a){return a?a.split(/\n/g):""}}).filter("calculatetime",function(){return function(a){if(!a||!angular.isNumber(a))return"";var b=new Date(a),c=new Date,d=c-b,e=Math.round(d/864e5);if(1>e){var f=Math.round(d/36e5);if(1>f){var g=Math.round(d/6e4)+1;return g+"分钟前"}return f+"小时前"}return e>5?a:e+"天前"}}).filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}}),angular.module("ponmApp.directives").directive("flexText",["$compile","$rootScope","$log",function(){function a(a,b){this.$textarea=a,this.options=b,this._init()}return a.prototype={_init:function(){var a=this;this.$textarea.wrap('<div class="flex-text-wrap" />').before("<pre><span /><br /></pre>"),a.options.hasUnderline&&this.$textarea.after('<div class="under-line"/>'),this.$span=this.$textarea.parent().find("span"),this.$underLine=this.$textarea.parent().find(".under-line"),this.$textarea.on("input propertychange keyup change",function(){a._mirror()}),this.$textarea.on("focus",function(){a.$underLine&&a.$underLine.addClass("active")}),this.$textarea.on("blur",function(){a.$underLine&&a.$underLine.removeClass("active")}),this._mirror()},_mirror:function(){this.$span.text(this.$textarea.val())}},{restrict:"A",link:function(b,c,d){var e=new a(c,{hasUnderline:!!d.hasUnderline});b.$watch(function(){return c.val()},function(){e._mirror()})}}}]),angular.module("ponmApp.directives").directive("ponmPhotoContainer",["$window","$parse","$animate","$log",function(a,b,c,d){var e=function(a,b){function e(){var d;m=new THREE.PerspectiveCamera(75,2,1,1100),m.target=new THREE.Vector3(0,0,0),n=new THREE.Scene;var e=new THREE.SphereGeometry(500,60,40);e.applyMatrix((new THREE.Matrix4).makeScale(-1,1,1));var k=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(b)});d=new THREE.Mesh(e,k),n.add(d),o=new THREE.WebGLRenderer,o.setSize(a.innerWidth(),a.innerHeight()),a.append(o.domElement),c.addClass(angular.element(o.domElement),"show"),o.domElement.addEventListener("mousedown",g,!1),o.domElement.addEventListener("mousemove",h,!1),o.domElement.addEventListener("mouseup",i,!1),o.domElement.addEventListener("mouseleave",i,!1),o.domElement.addEventListener("mousewheel",j,!1),o.domElement.addEventListener("DOMMouseScroll",j,!1),o.domElement.addEventListener("click",function(a){a.preventDefault(),u=!u},!1),o.domElement.addEventListener("dragover",function(a){a.preventDefault(),a.dataTransfer.dropEffect="copy"},!1),o.domElement.addEventListener("dragenter",function(){document.body.style.opacity=.5},!1),o.domElement.addEventListener("dragleave",function(){document.body.style.opacity=1},!1),o.domElement.addEventListener("drop",function(a){a.preventDefault();var b=new FileReader;b.addEventListener("load",function(a){k.map.image.src=a.target.result,k.map.needsUpdate=!0},!1),b.readAsDataURL(a.dataTransfer.files[0]),document.body.style.opacity=1},!1),window.addEventListener("resize",f,!1)}function f(){m.updateProjectionMatrix(),o.setSize(a.innerWidth(),a.innerHeight())}function g(a){a.preventDefault(),t=!0,p=a.clientX,q=a.clientY,r=v,s=w}function h(a){t===!0&&(v=.1*(p-a.clientX)+r,w=.1*(a.clientY-q)+s)}function i(){t=!1}function j(a){a.preventDefault();var b=m.fov;a.wheelDeltaY?b-=.05*a.wheelDeltaY:a.wheelDelta?b-=.05*a.wheelDelta:a.detail&&(b+=1*a.detail),b>10&&150>b&&(m.fov=b),d.debug("camera.fov "+m.fov),m.updateProjectionMatrix()}function k(){requestAnimationFrame(k),l()}function l(){t===!1&&u&&(v+=.1),w=Math.max(-85,Math.min(85,w)),x=THREE.Math.degToRad(90-w),y=THREE.Math.degToRad(v),m.target.x=500*Math.sin(x)*Math.cos(y),m.target.y=500*Math.cos(x),m.target.z=500*Math.sin(x)*Math.sin(y),m.lookAt(m.target),o.render(n,m)}var m,n,o,p,q,r,s,t=!1,u=!0,v=0,w=0,x=0,y=0;return e(),k(),o.domElement};return{restrict:"EA",templateUrl:"views/ponmPhotoContainer.html",link:function(b,f,g){function h(a){d.debug("changeP360: "+a),a?(c.addClass(t,"show"),c.addClass(r,"p360")):c.removeClass(t,"show")}function i(a){x=angular.element(a).panzoom({$zoomIn:f.parent().find(".zoom-in"),$zoomOut:f.parent().find(".zoom-out"),$zoomRange:f.parent().find(".zoom-range"),$reset:f.parent().find(".reset"),transition:!0}),x.parent().on("mousewheel.focal",function(a){a.preventDefault();var b=a.delta||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0;x.panzoom("zoom",c,{increment:.1,animate:!0,focal:a})}),x.on("panzoomzoom",function(a,b,c){1>c?(x.panzoom("resetZoom"),x.panzoom("resetPan")):Math.abs(c-1)<.05&&(1!=c&&x.panzoom("resetZoom"),x.panzoom("resetPan"))})}function j(){x.panzoom("reset")}function k(){if(g.ponmPhotoSrcL1){var a=g.ponmPhotoIs360&&"false"!=g.ponmPhotoIs360;r&&(r.find(".flat-canvas").empty(),h(a),c.removeClass(s,"show"),c.addClass(r,"show")),g.ponmPhotoSrcL1&&(m=new Image,m.onload=function(){var a=angular.element(m);o=a.outerWidth(),p=a.outerHeight(),y=p/o,d.debug("image: "+o+"x"+p),l(),c.addClass(angular.element(this),"show"),n&&c.removeClass(angular.element(n),"show")},n&&(angular.element(m).css("position","absolute"),angular.element(m).css("top","0")),m.src=g.ponmPhotoSrcL1,r.find(".flat-canvas").append(m),i(r.find(".flat-canvas")),j())}}function l(){v=f.innerWidth(),w=f.innerHeight(),q.css("line-height",w+"px")}var m=null,n=null,o=1,p=1,q=f.find(".ponm-photo-container"),r=f.find(".flat-image"),s=f.find(".p360-image"),t=f.find(".flat-image .image-button"),u=f.find(".p360-image .image-button");t.on("click",function(a){a.preventDefault(),c.removeClass(r,"show"),c.addClass(s,"show"),s.find("canvas").length&&t.ponmPhotoSrcL==g.ponmPhotoSrcL1?c.addClass(s,"show"):(t.ponmPhotoSrcL=g.ponmPhotoSrcL1,s.find(".p360-canvas").empty(),e(s.find(".p360-canvas"),g.ponmPhotoSrcL1,g.ponmPhotoWidth,g.ponmPhotoHeight))}),t.mouseenter(function(){t.find(".icon-p360").css("opacity",1)}),t.mouseout(function(){t.find(".icon-p360").css("opacity",.5)}),u.on("click",function(a){a.preventDefault(),d.debug("click on image360"),c.removeClass(s,"show"),c.addClass(r,"show")}),u.mouseenter(function(){u.find(".icon-pflat").css("opacity",1)}),u.mouseout(function(){u.find(".icon-pflat").css("opacity",.5)}),f.css("width","100%"),f.css("height","100%"),f.css("background-color",g.ponmPhotoColor);var v=f.innerWidth(),w=f.innerHeight();b.$watch(function(){return g.ponmPhotoIs360},function(){}),b.$watch(function(){return g.ponmPhotoSrcL1},function(){k()});var x=null;angular.element(a).resize(function(){l()});var y=null}}}]),angular.module("ponmApp.directives").directive("photoFluidContainer",["$window","$parse","$animate","$log","$timeout",function(a,b,c,d,e){return{restrict:"A",link:function(b,c,f){function g(){var a=c.innerWidth()-10,b=c.find(k),e=[],f=0;angular.forEach(b,function(b){b=angular.element(b);var c=b.outerWidth(),d=b.outerHeight(),g=f+c*j/d;g>a?(h(e,a/f*j),e=[b],f=j*c/d):(e.push(b),f=g)}),e.length&&(d.debug("itemLineWidth: "+f),h(e,a/f*j))}function h(a,b){b>i&&(b=i),angular.forEach(a,function(a){var c=a.find("img");a.css("height",b+"px"),c.css("height",b-4+"px")})}var i=0,j=0;i=b.$eval(f.fluidLineMaxHeight)||200,j=b.$eval(f.fluidLineMinHeight)||100;var k=f.itemSelector||".fluid-brick";$(a).resize(function(){d.debug("window resize"),g()}),b.$on("ponmPhotoFluidResize",function(){d.debug("ponmPhotoFluidResize"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},500)}),b.updateFluid=function(){if(d.debug("updateFluid"),a.imagesLoaded){var b=a.imagesLoaded&&a.imagesLoaded(c);b.on("always",function(){d.debug("imagesLoaded"),g()})}},b.$watch(f.photoFluidContainer,function(){d.debug("photoFluidContainer changed"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},1e3)})}}}]).directive("ponmPhoto",["$window","$parse","$animate","$log",function(a,b,c){return{restrict:"A",link:function(a,b){b.find(".action");b.on("mouseenter",function(){var a=b.find(".action");c.addClass(a,"ponm-show")}),b.on("mouseleave",function(){var a=b.find(".action");c.removeClass(a,"ponm-show")});var d=b.find(".action.ponm-photo-remove");d.on("click",function(b){b.preventDefault(),b.stopPropagation(),a.$emit("photoDeleteEvent",a.photo.id)})}}}]).directive("ponmHover",["$window","$parse","$animate","$log",function(){return{restrict:"A",link:function(a,b,c){var d=a.$eval(c.ponmHover);b.on("mouseenter",function(a){d.enter.apply(b,["enter",a])}),b.on("mouseleave",function(a){d.leave.apply(b,["leave",a])})}}}]),angular.module("ponmApp.directives").directive("ponmComment",["$window","$animate","$log","CommentService","param","$q",function(a,b,c,d,e,f){return{restrict:"A",scope:{comment:"=",userId:"=",deletedComment:"&"},templateUrl:"views/ponmComment.html",link:function(b,c){b.apirest=a.apirest,b.comment.editable=b.comment.userId==b.userId;c.find(".thumbs-up"),c.find(".action");b.userId&&(c.on("mouseenter",function(){b.$apply(function(){b.mouseEnter=!0})}),c.on("mouseleave",function(){b.$apply(function(){b.mouseEnter=!1})})),b.deleteCommment=function(a){d.delete({commentId:a.id},function(c){"OK"==c.status&&b.deletedComment&&b.deletedComment(b)()(a.id)})},b.modifyComment=function(a,b){var c=f.defer();return b&&d.modify({commentId:a.id},e({content:b}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise}}}}]),angular.module("ponmApp.directives").directive("repeatComplete",["$rootScope",function(a){function b(b,d){var e=++c;b.attr("repeat-complete-id",e),b.removeAttr("repeat-complete");var f=d.repeatComplete,g=b.parent(),h=g.scope()||a,i=h.$watch(function(){console.info("Digest running.");var a=g.children("*[ repeat-complete-id = '"+e+"' ]:last");if(a.length){var b=a.scope();b.$last&&(i(),b.$eval(f))}})}var c=0;return{compile:b,priority:1001,restrict:"A"}}]);